name: CI - Pull Request Checks

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

env:
  AWS_REGION: us-east-1
  ECR_FRONTEND_REPOSITORY: dark-trifid-frontend
  ECR_BACKEND_REPOSITORY: dark-trifid-backend

jobs:
  # Job 1: Validar c√≥digo y configuraci√≥n
  validate:
    name: Validate Code and Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for sensitive data
        run: |
          echo "üîç Checking for sensitive data..."
          if grep -r "AKIA" . --exclude-dir=.git; then
            echo "‚ùå Found AWS credentials in code!"
            exit 1
          fi
          echo "‚úÖ No sensitive data found"

      - name: Validate Docker Compose
        run: |
          echo "üê≥ Validating docker-compose files..."
          docker compose -f docker-compose.yml config > /dev/null
          docker compose -f docker-compose.prod.yml config > /dev/null
          echo "‚úÖ Docker Compose files are valid"

      - name: Check file structure
        run: |
          echo "üìÅ Checking project structure..."
          required_files=(
            "docker-compose.yml"
            "docker-compose.prod.yml"
            "frontend/Dockerfile"
            "backend/Dockerfile"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              exit 1
            fi
          done
          echo "‚úÖ All required files present"

  # Job 2: Validar Terraform
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

  # Job 3: Build Test (sin push)
  build-test:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Frontend Image
        run: |
          echo "üèóÔ∏è Building frontend..."
          docker build -t dark-trifid-frontend:test -f frontend/Dockerfile .
          echo "‚úÖ Frontend builds successfully"

      - name: Build Backend Image
        run: |
          echo "üèóÔ∏è Building backend..."
          docker build -t dark-trifid-backend:test -f backend/Dockerfile backend/
          echo "‚úÖ Backend builds successfully"

      - name: Test Images Size
        run: |
          FRONTEND_SIZE=$(docker images dark-trifid-frontend:test --format "{{.Size}}")
          BACKEND_SIZE=$(docker images dark-trifid-backend:test --format "{{.Size}}")
          echo "üìä Frontend image size: $FRONTEND_SIZE"
          echo "üìä Backend image size: $BACKEND_SIZE"

  # Job 4: Security Scan (opcional)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'  # No fallar el PR, solo informar
          severity: 'CRITICAL,HIGH'

  # Job 5: Comentar en el PR
  pr-comment:
    name: PR Summary
    needs: [validate, terraform-validate, build-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const validationStatus = '${{ needs.validate.result }}';
            const terraformStatus = '${{ needs.terraform-validate.result }}';
            const buildStatus = '${{ needs.build-test.result }}';
            
            const statusEmoji = (status) => {
              return status === 'success' ? '‚úÖ' : status === 'failure' ? '‚ùå' : '‚ö†Ô∏è';
            };
            
            const comment = `## üîç Pull Request Checks
            
            | Check | Status |
            |-------|--------|
            | Code Validation | ${statusEmoji(validationStatus)} ${validationStatus} |
            | Terraform Validation | ${statusEmoji(terraformStatus)} ${terraformStatus} |
            | Docker Build Test | ${statusEmoji(buildStatus)} ${buildStatus} |
            
            ${validationStatus === 'success' && terraformStatus === 'success' && buildStatus === 'success' 
              ? '‚úÖ **All checks passed!** This PR is ready for review.' 
              : '‚ö†Ô∏è **Some checks failed.** Please review the errors above.'}
            
            ---
            
            ### Next Steps:
            ${validationStatus === 'success' && terraformStatus === 'success' && buildStatus === 'success'
              ? '1. Request review from team members\n2. Once approved, merge to trigger deployment'
              : '1. Fix the failing checks\n2. Push changes to update this PR'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
